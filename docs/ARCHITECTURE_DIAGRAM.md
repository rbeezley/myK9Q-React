# myK9Q Three-Tier Architecture Diagram

**Purpose:** Visual documentation of the data flow through the application's three-tier architecture: **Stores â†’ Services â†’ Database**

**Generated:** 2025-10-25

---

## ğŸ›ï¸ Architectural Overview

myK9Q follows a strict three-tier separation of concerns:

1. **Stores (Zustand)** - Client-side state management
2. **Services** - Business logic and API communication
3. **Database (Supabase)** - PostgreSQL with real-time subscriptions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           USER INTERFACE LAYER                              â”‚
â”‚                         (React Components / Pages)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ hooks (useEntryStore, useScoringStore)
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            STORE LAYER (Zustand)                            â”‚
â”‚                                                                             â”‚
â”‚  entryStore.ts          scoringStore.ts        offlineQueueStore.ts        â”‚
â”‚  nationalsStore.ts      timerStore.ts          announcementStore.ts        â”‚
â”‚                                                                             â”‚
â”‚  - Client-side state    - Actions/mutations    - Devtools middleware       â”‚
â”‚  - Filter/pagination    - Derived selectors    - LocalStorage persistence  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ calls service functions
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SERVICE LAYER (Business Logic)                     â”‚
â”‚                                                                             â”‚
â”‚  entryService.ts        placementService.ts    nationalsScoring.ts         â”‚
â”‚  authService.ts         syncManager.ts         announcementService.ts      â”‚
â”‚                                                                             â”‚
â”‚  - API calls            - Data transformation  - Validation                â”‚
â”‚  - Real-time subs       - Error handling       - Multi-tenant filtering    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ Supabase client (REST + Realtime)
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DATABASE LAYER (Supabase/PostgreSQL)                 â”‚
â”‚                                                                             â”‚
â”‚  shows â†’ trials â†’ classes â†’ entries â†’ results                              â”‚
â”‚                                                                             â”‚
â”‚  - Row-level security   - Real-time triggers   - Multi-tenant isolation    â”‚
â”‚  - Foreign key refs     - CHECK constraints    - Indexes for performance   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Detailed Data Flow Diagrams

### 1. Entry Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER ACTION: Judge clicks on a class to view entries                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COMPONENT: ClassDetail.tsx                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  useEffect(() => {                                                       â”‚
â”‚    const loadEntries = async () => {                                     â”‚
â”‚      const entries = await entryService.getClassEntries(classId, key);   â”‚
â”‚      entryStore.setEntries(entries);                                     â”‚
â”‚    };                                                                     â”‚
â”‚  }, [classId]);                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SERVICE: entryService.ts                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  export async function getClassEntries(                                  â”‚
â”‚    classIds: number | number[],                                         â”‚
â”‚    licenseKey: string                                                    â”‚
â”‚  ): Promise<Entry[]> {                                                   â”‚
â”‚    // Step 1: Query database with proper joins                          â”‚
â”‚    const { data } = await supabase                                       â”‚
â”‚      .from('entries')                                                    â”‚
â”‚      .select(`                                                           â”‚
â”‚        *,                                                                â”‚
â”‚        classes!inner (                                                   â”‚
â”‚          element, level, section,                                        â”‚
â”‚          trials!inner (                                                  â”‚
â”‚            trial_date, trial_number,                                     â”‚
â”‚            shows!inner (license_key)                                     â”‚
â”‚          )                                                               â”‚
â”‚        )                                                                 â”‚
â”‚      `)                                                                  â”‚
â”‚      .in('class_id', classIdArray)                                       â”‚
â”‚      .eq('classes.trials.shows.license_key', licenseKey); â”€â”€â”            â”‚
â”‚                                                             â”‚            â”‚
â”‚    // Step 2: Fetch results separately                     â”‚            â”‚
â”‚    const { data: resultsData } = await supabase            â”‚            â”‚
â”‚      .from('results')                                      â”‚            â”‚
â”‚      .select('entry_id, is_scored, search_time_seconds')  â”‚            â”‚
â”‚      .in('entry_id', entryIds);                            â”‚            â”‚
â”‚                                                             â”‚            â”‚
â”‚    // Step 3: Transform DB format to TS interface          â”‚            â”‚
â”‚    return viewData.map(row => ({                           â”‚            â”‚
â”‚      id: row.id,                                           â”‚            â”‚
â”‚      armband: row.armband_number, â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚      callName: row.dog_call_name,  // snake_case â†’ camelCase            â”‚
â”‚      status: row.entry_status,     // DB ENUM â†’ TS union type           â”‚
â”‚      isScored: result?.is_scored,  // Join results data                 â”‚
â”‚      timeLimit: secondsToTimeString(classData.time_limit_seconds) â—„â”€â”€â”  â”‚
â”‚      // ... more transformations                                    â”‚  â”‚
â”‚    }));                                                               â”‚  â”‚
â”‚  }                                                                    â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”˜
                                  â”‚                                     â”‚
                                  â–¼                           TIME CONVERSION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATABASE: Supabase PostgreSQL                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                          â”‚
â”‚  SELECT e.*, c.element, c.level, t.trial_date, s.license_key            â”‚
â”‚  FROM entries e                                                          â”‚
â”‚  INNER JOIN classes c ON e.class_id = c.id                              â”‚
â”‚  INNER JOIN trials t ON c.trial_id = t.id                               â”‚
â”‚  INNER JOIN shows s ON t.show_id = s.id                                 â”‚
â”‚  WHERE s.license_key = 'myK9Q1-...' â—„â”€â”€â”€ Multi-tenant filtering         â”‚
â”‚    AND e.class_id IN (275, 276)                                          â”‚
â”‚  ORDER BY e.armband_number ASC;                                          â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ entries             â”‚     â”‚ results             â”‚                    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  â”‚ id: 6714            â”‚â”€â”€â”€â”€â–ºâ”‚ entry_id: 6714      â”‚ â—„â”€â”€â”€ 1:1           â”‚
â”‚  â”‚ armband_number: 101 â”‚     â”‚ is_scored: false    â”‚                    â”‚
â”‚  â”‚ dog_call_name: Max  â”‚     â”‚ search_time_sec: 0  â”‚                    â”‚
â”‚  â”‚ entry_status: none  â”‚     â”‚ result_status: pend â”‚                    â”‚
â”‚  â”‚ class_id: 275       â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚          â”‚                                                               â”‚
â”‚          â””â”€â–º classes.id = 275 (Interior Novice A)                        â”‚
â”‚                  â”‚                                                       â”‚
â”‚                  â””â”€â–º trials.id = 42 (Trial 1, 2025-10-20)                â”‚
â”‚                          â”‚                                               â”‚
â”‚                          â””â”€â–º shows.id = 8 (license_key: myK9Q1-...)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STORE: entryStore.ts (Zustand)                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  setEntries: (entries) => {                                              â”‚
â”‚    set({                                                                 â”‚
â”‚      entries,                       â—„â”€â”€â”€ Update state                   â”‚
â”‚      totalEntries: entries.length,  â—„â”€â”€â”€ Derived count                  â”‚
â”‚      currentPage: 1                 â—„â”€â”€â”€ Reset pagination                â”‚
â”‚    });                                                                   â”‚
â”‚  }                                                                       â”‚
â”‚                                                                          â”‚
â”‚  State after update:                                                     â”‚
â”‚  {                                                                       â”‚
â”‚    entries: [                                                            â”‚
â”‚      { id: 6714, armband: 101, callName: 'Max', status: 'none', ... },  â”‚
â”‚      { id: 6715, armband: 102, callName: 'Bella', status: 'checked-in' }â”‚
â”‚    ],                                                                    â”‚
â”‚    totalEntries: 2,                                                      â”‚
â”‚    isLoading: false                                                      â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COMPONENT RE-RENDER: ClassDetail.tsx                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  const entries = useEntryStore(state => state.entries);                  â”‚
â”‚                                                                          â”‚
â”‚  return (                                                                â”‚
â”‚    <div>                                                                 â”‚
â”‚      {entries.map(entry => (                                             â”‚
â”‚        <DogCard key={entry.id} entry={entry} />                          â”‚
â”‚      ))}                                                                 â”‚
â”‚    </div>                                                                â”‚
â”‚  );                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. Score Submission Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER ACTION: Judge submits a score on a scoresheet                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COMPONENT: AKCScentWorkScoresheet.tsx                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  const handleSubmit = async () => {                                      â”‚
â”‚    const scoreData = {                                                   â”‚
â”‚      resultText: 'Qualified',                                            â”‚
â”‚      searchTime: '1:32',        â—„â”€â”€â”€ MM:SS format                        â”‚
â”‚      faultCount: 0,                                                      â”‚
â”‚      areaTimes: ['1:32']        â—„â”€â”€â”€ Multi-area times                    â”‚
â”‚    };                                                                    â”‚
â”‚                                                                          â”‚
â”‚    await entryService.submitScore(entryId, scoreData);                   â”‚
â”‚    scoringStore.submitScore({ entryId, ...scoreData });                  â”‚
â”‚  };                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SERVICE: entryService.ts                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  export async function submitScore(entryId, scoreData) {                 â”‚
â”‚    // Step 1: Map user-friendly values to DB enums                      â”‚
â”‚    let resultStatus = 'pending';                                         â”‚
â”‚    if (scoreData.resultText === 'Qualified') {                           â”‚
â”‚      resultStatus = 'qualified'; â—„â”€â”€â”€ UI value â†’ DB ENUM                 â”‚
â”‚    }                                                                     â”‚
â”‚                                                                          â”‚
â”‚    // Step 2: Transform time format                                     â”‚
â”‚    const searchTimeSeconds = convertTimeToSeconds(scoreData.searchTime); â”‚
â”‚    // '1:32' â†’ 92 seconds â—„â”€â”€â”€ String â†’ Number                          â”‚
â”‚                                                                          â”‚
â”‚    // Step 3: Build DB payload (snake_case)                             â”‚
â”‚    const resultData = {                                                  â”‚
â”‚      entry_id: entryId,                                                  â”‚
â”‚      result_status: resultStatus,      // 'qualified'                    â”‚
â”‚      search_time_seconds: 92,          // numeric                        â”‚
â”‚      is_scored: true,                  // boolean                        â”‚
â”‚      is_in_ring: false,                // boolean                        â”‚
â”‚      scoring_completed_at: new Date().toISOString() // timestamptz       â”‚
â”‚    };                                                                    â”‚
â”‚                                                                          â”‚
â”‚    // Step 4: Handle multi-area times                                   â”‚
â”‚    if (scoreData.areaTimes?.length > 0) {                                â”‚
â”‚      resultData.area1_time_seconds = convertTimeToSeconds(               â”‚
â”‚        scoreData.areaTimes[0]                                            â”‚
â”‚      ); // '1:32' â†’ 92                                                   â”‚
â”‚    }                                                                     â”‚
â”‚                                                                          â”‚
â”‚    // Step 5: Upsert to database                                        â”‚
â”‚    const { error } = await supabase                                      â”‚
â”‚      .from('results')                                                    â”‚
â”‚      .upsert(resultData, {                                               â”‚
â”‚        onConflict: 'entry_id',    â—„â”€â”€â”€ 1:1 relationship enforcement      â”‚
â”‚        ignoreDuplicates: false                                           â”‚
â”‚      });                                                                 â”‚
â”‚                                                                          â”‚
â”‚    // Step 6: Recalculate placements for entire class                   â”‚
â”‚    await placementService.recalculatePlacementsForClass(                 â”‚
â”‚      classId, licenseKey, isNationals                                    â”‚
â”‚    );                                                                    â”‚
â”‚                                                                          â”‚
â”‚    // Step 7: Update class completion status                            â”‚
â”‚    await checkAndUpdateClassCompletion(classId);                         â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATABASE: Supabase PostgreSQL                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  -- UPSERT operation                                                     â”‚
â”‚  INSERT INTO results (                                                   â”‚
â”‚    entry_id,                                                             â”‚
â”‚    result_status,                                                        â”‚
â”‚    search_time_seconds,                                                  â”‚
â”‚    area1_time_seconds,                                                   â”‚
â”‚    is_scored,                                                            â”‚
â”‚    scoring_completed_at                                                  â”‚
â”‚  ) VALUES (                                                              â”‚
â”‚    6714,                                                                 â”‚
â”‚    'qualified',             â—„â”€â”€â”€ CHECK constraint validated              â”‚
â”‚    92,                      â—„â”€â”€â”€ numeric type                            â”‚
â”‚    92,                                                                   â”‚
â”‚    true,                                                                 â”‚
â”‚    '2025-10-25T14:32:00Z'                                                â”‚
â”‚  )                                                                       â”‚
â”‚  ON CONFLICT (entry_id) DO UPDATE â—„â”€â”€â”€ 1:1 enforcement                   â”‚
â”‚  SET result_status = EXCLUDED.result_status,                             â”‚
â”‚      search_time_seconds = EXCLUDED.search_time_seconds,                 â”‚
â”‚      is_scored = EXCLUDED.is_scored,                                     â”‚
â”‚      updated_at = now();                                                 â”‚
â”‚                                                                          â”‚
â”‚  -- Trigger fires: updated_at auto-set                                  â”‚
â”‚  -- Real-time subscription broadcasts change                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SERVICE: placementService.ts                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  export async function recalculatePlacementsForClass(                    â”‚
â”‚    classId, licenseKey, isNationals                                      â”‚
â”‚  ) {                                                                     â”‚
â”‚    // Fetch all qualified results for this class                        â”‚
â”‚    const results = await supabase                                        â”‚
â”‚      .from('results')                                                    â”‚
â”‚      .select('*, entries!inner(class_id)')                               â”‚
â”‚      .eq('entries.class_id', classId)                                    â”‚
â”‚      .eq('result_status', 'qualified');                                  â”‚
â”‚                                                                          â”‚
â”‚    // Sort by faults (asc), then time (asc)                             â”‚
â”‚    const sorted = results.sort((a, b) => {                               â”‚
â”‚      if (a.total_faults !== b.total_faults) {                            â”‚
â”‚        return a.total_faults - b.total_faults;                           â”‚
â”‚      }                                                                   â”‚
â”‚      return a.search_time_seconds - b.search_time_seconds;               â”‚
â”‚    });                                                                   â”‚
â”‚                                                                          â”‚
â”‚    // Assign placements: 1st, 2nd, 3rd, 4th                             â”‚
â”‚    for (let i = 0; i < sorted.length; i++) {                             â”‚
â”‚      await supabase                                                      â”‚
â”‚        .from('results')                                                  â”‚
â”‚        .update({ final_placement: i + 1 })                               â”‚
â”‚        .eq('entry_id', sorted[i].entry_id);                              â”‚
â”‚    }                                                                     â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REAL-TIME SUBSCRIPTION: syncManager.ts                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  supabase                                                                â”‚
â”‚    .channel('results-changes')                                           â”‚
â”‚    .on('postgres_changes',                                               â”‚
â”‚      { event: 'UPDATE', schema: 'public', table: 'results' },            â”‚
â”‚      (payload) => {                                                      â”‚
â”‚        console.log('Real-time update:', payload.new);                    â”‚
â”‚        // Broadcast to subscribers                                      â”‚
â”‚        onUpdate(payload);                                                â”‚
â”‚      }                                                                   â”‚
â”‚    )                                                                     â”‚
â”‚    .subscribe();                                                         â”‚
â”‚                                                                          â”‚
â”‚  Payload received:                                                       â”‚
â”‚  {                                                                       â”‚
â”‚    eventType: 'UPDATE',                                                  â”‚
â”‚    new: {                                                                â”‚
â”‚      entry_id: 6714,                                                     â”‚
â”‚      result_status: 'qualified',                                         â”‚
â”‚      is_scored: true,                                                    â”‚
â”‚      final_placement: 1  â—„â”€â”€â”€ Updated by placementService                â”‚
â”‚    },                                                                    â”‚
â”‚    old: { ... }                                                          â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STORE: entryStore.ts                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  updateEntry: (entryId, updates) => {                                    â”‚
â”‚    set((state) => ({                                                     â”‚
â”‚      entries: state.entries.map(entry =>                                 â”‚
â”‚        entry.id === entryId                                              â”‚
â”‚          ? { ...entry, ...updates }  â—„â”€â”€â”€ Merge updates                  â”‚
â”‚          : entry                                                         â”‚
â”‚      )                                                                   â”‚
â”‚    }));                                                                  â”‚
â”‚  }                                                                       â”‚
â”‚                                                                          â”‚
â”‚  // Called via real-time subscription                                   â”‚
â”‚  updateEntry(6714, {                                                     â”‚
â”‚    isScored: true,                                                       â”‚
â”‚    resultText: 'qualified',                                              â”‚
â”‚    searchTime: '1:32',                                                   â”‚
â”‚    placement: 1                                                          â”‚
â”‚  });                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COMPONENT RE-RENDER: DogCard.tsx                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  const entry = useEntryStore(state =>                                    â”‚
â”‚    state.entries.find(e => e.id === 6714)                                â”‚
â”‚  );                                                                      â”‚
â”‚                                                                          â”‚
â”‚  return (                                                                â”‚
â”‚    <div className="dog-card">                                            â”‚
â”‚      <h3>#{entry.armband} - {entry.callName}</h3>                        â”‚
â”‚      <Badge status="scored">Qualified</Badge> â—„â”€â”€â”€ Updates instantly     â”‚
â”‚      <div className="placement">1st Place</div>  â—„â”€â”€â”€ Placement shown    â”‚
â”‚    </div>                                                                â”‚
â”‚  );                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. Real-time Subscription Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER ACTION: Gate steward checks in a dog on their device               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DEVICE A (Gate Steward): Updates entry status                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  await entryService.updateEntryCheckinStatus(6714, 'checked-in');        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATABASE: entries table updated                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  UPDATE entries                                                          â”‚
â”‚  SET entry_status = 'checked-in', updated_at = now()                     â”‚
â”‚  WHERE id = 6714;                                                        â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚  â”‚ entries             â”‚                                                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                                 â”‚
â”‚  â”‚ id: 6714            â”‚                                                 â”‚
â”‚  â”‚ entry_status: none  â”‚ â”€â”€â–º entry_status: 'checked-in' â—„â”€â”€â”€ CHANGED    â”‚
â”‚  â”‚ updated_at: old     â”‚ â”€â”€â–º updated_at: now()          â—„â”€â”€â”€ TRIGGER    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚                                                                          â”‚
â”‚  Real-time trigger broadcasts to ALL subscribed clients                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                         â”‚
                     â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DEVICE B (Judge's Tablet)  â”‚   â”‚ DEVICE C (TV Display)      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ syncManager receives:      â”‚   â”‚ syncManager receives:      â”‚
â”‚                            â”‚   â”‚                            â”‚
â”‚ {                          â”‚   â”‚ {                          â”‚
â”‚   eventType: 'UPDATE',     â”‚   â”‚   eventType: 'UPDATE',     â”‚
â”‚   table: 'entries',        â”‚   â”‚   table: 'entries',        â”‚
â”‚   new: {                   â”‚   â”‚   new: {                   â”‚
â”‚     id: 6714,              â”‚   â”‚     id: 6714,              â”‚
â”‚     entry_status:          â”‚   â”‚     entry_status:          â”‚
â”‚       'checked-in'         â”‚   â”‚       'checked-in'         â”‚
â”‚   },                       â”‚   â”‚   },                       â”‚
â”‚   old: {                   â”‚   â”‚   old: {                   â”‚
â”‚     entry_status: 'none'   â”‚   â”‚     entry_status: 'none'   â”‚
â”‚   }                        â”‚   â”‚   }                        â”‚
â”‚ }                          â”‚   â”‚ }                          â”‚
â”‚                            â”‚   â”‚                            â”‚
â”‚ â†“ Callback triggers        â”‚   â”‚ â†“ Callback triggers        â”‚
â”‚                            â”‚   â”‚                            â”‚
â”‚ entryStore.updateEntry(    â”‚   â”‚ entryStore.updateEntry(    â”‚
â”‚   6714,                    â”‚   â”‚   6714,                    â”‚
â”‚   { status: 'checked-in' } â”‚   â”‚   { status: 'checked-in' } â”‚
â”‚ );                         â”‚   â”‚ );                         â”‚
â”‚                            â”‚   â”‚                            â”‚
â”‚ â†“ Component re-renders     â”‚   â”‚ â†“ Component re-renders     â”‚
â”‚                            â”‚   â”‚                            â”‚
â”‚ <DogCard>                  â”‚   â”‚ <TVDisplay>                â”‚
â”‚   <Badge>Checked In</Badge>â”‚   â”‚   âœ… #101 Max - Ready      â”‚
â”‚ </DogCard>                 â”‚   â”‚ </TVDisplay>               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ Store Inventory

### Core Stores

| Store | Location | Purpose | Persistence |
|-------|----------|---------|-------------|
| `entryStore` | [src/stores/entryStore.ts](../src/stores/entryStore.ts) | Entry data, filters, pagination | None (session-only) |
| `scoringStore` | [src/stores/scoringStore.ts](../src/stores/scoringStore.ts) | Active scoring sessions, timer state | LocalStorage (persist middleware) |
| `offlineQueueStore` | [src/stores/offlineQueueStore.ts](../src/stores/offlineQueueStore.ts) | Offline sync queue | LocalStorage |
| `nationalsStore` | [src/stores/nationalsStore.ts](../src/stores/nationalsStore.ts) | Nationals-specific scoring state | None |
| `timerStore` | [src/stores/timerStore.ts](../src/stores/timerStore.ts) | Multi-timer management | None |
| `announcementStore` | [src/stores/announcementStore.ts](../src/stores/announcementStore.ts) | Push notification state | None |

---

## ğŸ› ï¸ Service Inventory

### Core Services

| Service | Location | Responsibilities |
|---------|----------|------------------|
| `entryService` | [src/services/entryService.ts](../src/services/entryService.ts) | Entry CRUD, score submission, real-time subscriptions |
| `placementService` | [src/services/placementService.ts](../src/services/placementService.ts) | Placement calculation, tie-breaking logic |
| `authService` | [src/services/authService.ts](../src/services/authService.ts) | Passcode-based authentication, role derivation |
| `nationalsScoring` | [src/services/nationalsScoring.ts](../src/services/nationalsScoring.ts) | Nationals-specific scoring rules |
| `syncManager` | [src/services/syncManager.ts](../src/services/syncManager.ts) | Real-time subscription management |
| `announcementService` | [src/services/announcementService.ts](../src/services/announcementService.ts) | Push notification CRUD |

---

## ğŸ”„ Data Transformation Pipeline

### Read Flow (Database â†’ UI)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Database Query (snake_case columns)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  {
    id: 6714,
    armband_number: 101,          â—„â”€â”€â”€ PostgreSQL column names
    dog_call_name: 'Max',
    entry_status: 'checked-in',
    class_id: 275
  }
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: Service Layer Transformation (camelCase properties)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  {
    id: 6714,
    armband: 101,                 â—„â”€â”€â”€ Mapped to camelCase
    callName: 'Max',
    status: 'checked-in',         â—„â”€â”€â”€ ENUM validated
    classId: 275
  }
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: Store Updates State (Entry interface)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  entryStore.setEntries([...])
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: Component Renders (React)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  <DogCard entry={entry} />
```

### Write Flow (UI â†’ Database)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Component Submits Data (user-friendly values)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  {
    resultText: 'Qualified',      â—„â”€â”€â”€ Human-readable
    searchTime: '1:32',           â—„â”€â”€â”€ MM:SS format
    faultCount: 0
  }
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: Service Transforms (DB-compatible format)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  {
    result_status: 'qualified',   â—„â”€â”€â”€ ENUM value
    search_time_seconds: 92,      â—„â”€â”€â”€ Numeric (seconds)
    total_faults: 0
  }
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: Database Insert/Update (PostgreSQL)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  INSERT INTO results (entry_id, result_status, search_time_seconds, ...)
  VALUES (6714, 'qualified', 92, ...)
  ON CONFLICT (entry_id) DO UPDATE ...
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: Real-time Broadcast (Supabase)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  All subscribed clients receive UPDATE event
```

---

## ğŸš¨ Architectural Rules

### âœ… DO

1. **Always call services from components/pages**
   ```typescript
   // âœ… CORRECT
   const entries = await entryService.getClassEntries(classId, licenseKey);
   entryStore.setEntries(entries);
   ```

2. **Use stores for client-side state only**
   ```typescript
   // âœ… CORRECT
   const filters = useEntryStore(state => state.filters);
   const setFilter = useEntryStore(state => state.setFilter);
   ```

3. **Transform data in services, not components**
   ```typescript
   // âœ… CORRECT (in service)
   const searchTime = secondsToTimeString(row.search_time_seconds);
   ```

4. **Subscribe to real-time via syncManager**
   ```typescript
   // âœ… CORRECT
   import { syncManager } from '@/services/syncManager';
   syncManager.subscribeToUpdates('entries', filter, callback);
   ```

---

### âŒ DON'T

1. **Don't call Supabase directly from components**
   ```typescript
   // âŒ WRONG
   const { data } = await supabase.from('entries').select('*');
   ```

2. **Don't store server data in stores without service layer**
   ```typescript
   // âŒ WRONG
   const rawData = await fetchFromAPI();
   entryStore.setEntries(rawData); // No transformation!
   ```

3. **Don't transform data in components**
   ```typescript
   // âŒ WRONG (in component)
   const searchTime = `${Math.floor(seconds / 60)}:${seconds % 60}`;
   ```

4. **Don't bypass multi-tenant filtering**
   ```typescript
   // âŒ WRONG (missing license_key filter)
   const { data } = await supabase.from('entries').eq('class_id', 275);
   ```

---

## ğŸ“š Related Documentation

- [Database ERD](./DATABASE_ERD.md) - Entity relationship diagram
- [Type Mapping](./TYPE_MAPPING.md) - TypeScript â†” PostgreSQL mappings
- [CLAUDE.md](../CLAUDE.md) - Development guide

---

**Last Updated:** 2025-10-25
**Architecture Version:** Three-tier (Stores â†’ Services â†’ Database)
